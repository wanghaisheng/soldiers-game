
<html><head><base href=""><meta http-equiv="X-UA-Compatible" content="ie=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tower Defense Battle</title>
<style>
body {
    margin: 0;
    padding: 20px;
    background: #16213E; /* Lighter blue background */
    font-family: Arial, sans-serif;
    color: white;
}

.menu-logo {
    width: 500px; /* Adjusted width */
    height: auto;
    margin-bottom: 40px;
    image-rendering: pixelated;
    filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.5)); /* Add subtle shadow */
}

#gameContainer {
    max-width: 800px;
    margin: 0 auto;
    display: none; /* Hide game container initially */
}

#mainMenu {
    display: flex;
}

#mainMenu div {
    max-width: 800px;
    margin: 0 auto;
    text-align: center;
}

#mainMenu button {
    padding: 15px 30px;
    font-size: 24px;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 5px;
    transition: background 0.3s;
}

#mainMenu button:hover {
    filter: brightness(1.2);
}

.game-mode-selector {
    margin: 20px 0;
    padding: 20px;
    background: rgba(74, 74, 107, 0.5); /* More transparent for better contrast */
    border-radius: 10px;
}

.game-mode-selector h2 {
    color: #FFD700;
    margin-bottom: 15px;
}

.mode-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.mode-button {
    padding: 15px;
    background: #4A5BB9; /* Brighter blue */
    border: 2px solid transparent;
    color: white;
    cursor: pointer;
    border-radius: 5px;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 18px;
}

.mode-button:hover {
    background: #5B6ED1; /* Lighter hover state */
}

.mode-button.selected {
    border-color: #FFD700;
    background: #6B7FE3; /* Even lighter when selected */
}

.mode-description {
    font-size: 14px;
    opacity: 0.8;
    margin-top: 5px;
}

#currentMode {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(74, 74, 107, 0.7);
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 14px;
}

#battlefield {
    background: #1B2B65; /* Lighter battlefield background */
    border: 2px solid #5B6ED1; /* Brighter border */
    position: relative;
    height: 400px;
    margin-bottom: 20px;
}

.base {
    position: absolute;
    width: 150px; /* Increased from 100px */
    height: 150px; /* Increased from 100px */
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    image-rendering: pixelated;
}

#playerBase {
    left: 20px;
    bottom: 100px; /* Moved down from 150px */
    background-image: url('player base.png');
    color: transparent;
}

#enemyBase {
    right: 20px;
    bottom: 100px; /* Moved down from 150px */
    background-image: url('enemy base.png');
    color: transparent;
}

.unit {
    position: absolute;
    width: 80px; /* Increased from 50px */
    height: 80px; /* Increased from 50px */
    display: flex;
    align-items: center;
    justify-content: center;
    transition: left 0.5s linear;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    image-rendering: pixelated;
}

.player-unit {
    background-image: url('player unit.gif');
}

.player-unit.archer {
    background-image: url('player unit archer.gif');
}

.player-unit.wizard {
    background-image: url('player unit wizard.gif');
}

.player-unit.fencer {
    background-image: url('player unit fencer.gif');
}

.player-unit.alien {
    background-image: url('player unit alien WITH a laser gun.gif');
}

.player-unit.derpbot {
    background-image: url('player tall derpbot.gif');
}

.player-unit.redPlumber {
    background-image: url('red plumber unit.gif');
}

.player-unit.greenPlumber {
    background-image: url('green plumber unit.gif');
}

.player-unit.miniDerpbot {
    background-image: url('player mini derpbot.gif');
}

.player-unit.mushroom {
    background-image: url('player mushroom unit.gif');
}

.player-unit.hammer {
    background-image: url('hammer unit player.gif') !important; /* Add !important */
    transition: background-image 0.1s;
}

.unit.knight {
    background-image: url('knight.png');
}

.unit.evilWizard {
    background-image: url('EVILLL wizard.gif');
}

.enemy-unit {
    background-image: url('enemy unit.gif');
}

.enemy-unit.knight {
    background-image: url('enemy knight.gif');
}

.enemy-unit.fencer {
    background-image: url('enemy unit fencer.gif');
}

.enemy-unit.derpbot {
    background-image: url('enemy tall derpbot.gif');
}

.enemy-unit.miniDerpbot {
    background-image: url('enemy mini derpbot.gif');
}

.enemy-unit.mushroom {
    background-image: url('enemy mushroom unit.gif');
}

.unit.skeleton {
    background-image: url('skeleton.gif');
}

.unit.goblin {
    background-image: url('goblin unit player.gif');
}

.unit.rockBoss {
    background-image: url('flying rock boss.png');
    width: 120px; /* Larger size for boss */
    height: 120px;
}

.player-unit.oldMan {
    background-image: url('player unit, old man.gif');
}

.arrow {
    position: absolute;
    width: 20px;
    height: 10px;
    background-image: url('arrow.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    image-rendering: pixelated;
    transition: left 0.1s linear;
    z-index: 5;
}

.laser {
    position: absolute;
    width: 30px;
    height: 10px;
    background-image: url('alien laser bullet thingy.gif');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    image-rendering: pixelated;
    transition: left 0.1s linear;
    z-index: 5;
}

.zombie {
    background-image: url('enemy zombie.gif') !important; /* Update zombie image */
}

.zombie-fencer {
    background-image: url('zombie fencer.gif') !important;
}

.zombie-knight {
    background-image: url('zombie knight.gif') !important;
}

.zombie-red-plumber {
    background-image: url('zombie red plumber.gif') !important;
}

.zombie-green-plumber {
    background-image: url('zombie green plumber .gif') !important;
}

#unitSelection {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap; /* Allow buttons to wrap to next line */
    max-width: 800px; /* Match container width */
    justify-content: center; /* Center the buttons */
}

.unit-button {
    padding: 10px 15px; /* Slightly reduce padding */
    background: #4A5BB9;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 5px;
    transition: background 0.3s;
    font-size: 14px; /* Slightly smaller font */
    min-width: 120px; /* Set minimum width */
    margin: 5px; /* Add some margin between buttons */
}

.unit-button.locked {
    display: none;  /* Hide locked unit buttons instead of just styling them differently */
}

/* Add responsive adjustments */
@media (max-width: 850px) {
    #gameContainer {
        padding: 0 10px;
    }
    
    .unit-button {
        min-width: 100px;
        font-size: 12px;
        padding: 8px 12px;
    }
}

#resources {
    margin-bottom: 20px;
    font-size: 18px;
}

#retryButton {
    padding: 10px 20px;
    background: #4CAF50; /* Keep green but ensure it's vibrant */
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 5px;
    font-size: 16px;
    display: none;
}

#retryButton:hover {
    background: #45a049;
}

.health-bar {
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 100%;
    height: 5px;
    background: #ff0000;
}

.game-over-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    background: rgba(0, 0, 0, 0.8);
    z-index: 100;
}

.game-over-text {
    font-size: 48px;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

.win-screen {
    color: #4CAF50;
}

.lose-screen {
    color: #f44336;
}

.new-unit-unlock {
    font-size: 24px;
    color: #FFD700;
    margin-bottom: 20px;
    display: none;
}

#helpTooltip {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    padding: 20px;
    border-radius: 10px;
    border: 2px solid #4a4a6b;
    z-index: 1000;
    max-width: 400px;
    text-align: center;
}

#helpTooltip h2 {
    color: #FFD700;
    margin-top: 0;
}

#helpTooltip p {
    margin: 10px 0;
}

#helpTooltip .close-button {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 20px;
}

#nextBattleButton {
    padding: 10px 20px;
    background: #2196F3; /* Brighter blue */
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 5px;
    font-size: 16px;
    margin-left: 10px;
}

#nextBattleButton:hover {
    background: #1E88E5; /* Brighter blue */
}

.button-container {
    display: flex;
    gap: 15px;
    justify-content: center;
}

#backToMenuButton, #backToMenuLoseButton {
    padding: 10px 20px;
    background: #FF5722;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 5px;
    font-size: 16px;
}

#backToMenuButton:hover, #backToMenuLoseButton:hover {
    background: #F4511E;
}

#howToPlayModal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(26, 26, 46, 0.9); /* More transparent for better contrast */
    padding: 30px;
    border-radius: 10px;
    border: 2px solid #4a4a6b;
    z-index: 1000;
    max-width: 600px;
    width: 90%;
}

#howToPlayModal h2 {
    color: #FFD700;
    margin-top: 0;
}

#howToPlayModal .close-button {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 20px;
}

#infoModal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(26, 26, 46, 0.9); /* More transparent for better contrast */
    padding: 30px;
    border-radius: 10px;
    border: 2px solid #4a4a6b;
    z-index: 1000;
    max-width: 600px;
    width: 90%;
    color: white;
    max-height: 80vh; /* Add maximum height */
    overflow-y: auto; /* Enable vertical scrolling */
}

/* Add custom scrollbar styling */
#infoModal::-webkit-scrollbar {
    width: 10px;
}

#infoModal::-webkit-scrollbar-track {
    background: rgba(74, 74, 107, 0.4); /* Lighter scrollbar track */
    border-radius: 5px;
}

#infoModal::-webkit-scrollbar-thumb {
    background: #5B6ED1; /* Brighter scrollbar thumb */
    border-radius: 5px;
}

#infoModal::-webkit-scrollbar-thumb:hover {
    background: #6B7FE3; /* Lighter hover state */
}

/* Ensure the close button stays visible when scrolling */
#infoModal .close-button {
    position: sticky;
    top: -20px;
    right: -20px;
    float: right;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 20px;
    margin-bottom: 10px;
}

/* Add styles for unit images in info modal */
.unit-info {
    padding: 15px;
    background: rgba(74, 74, 107, 0.3); /* Lighter background */
    border-radius: 8px;
    margin-bottom: 15px;
}

.unit-info .unit-image {
    width: 80px;
    height: 80px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    image-rendering: pixelated;
    margin: 10px auto;
}

.unit-stats {
    background: rgba(74, 74, 107, 0.4); /* Lighter stats background */
    padding: 8px;
    border-radius: 5px;
    margin-top: 10px;
}

.info-section {
    margin-bottom: 30px;
}

.info-section h3 {
    color: #FFD700;
    border-bottom: 2px solid #4a4a6b;
    padding-bottom: 5px;
    margin-bottom: 15px;
}

/* Add new store styles */
.store-section {
    margin: 20px 0;
    padding: 20px;
    background: rgba(74, 74, 107, 0.5);
    border-radius: 10px;
}

.store-section h2 {
    color: #FFD700;
    margin-bottom: 15px;
}

.store-container {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}

.store-item {
    padding: 15px;
    background: #4A5BB9;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 5px;
    transition: all 0.3s;
    min-width: 200px;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.store-item:hover {
    background: #5B6ED1;
    transform: translateY(-2px);
}

.store-item img {
    width: 48px;
    height: 48px;
    image-rendering: pixelated;
}

.store-item-price {
    display: flex;
    align-items: center;
    gap: 5px;
}

.store-item-price img {
    width: 24px;
    height: 24px;
}

/* Add new lore section styling */
.lore-section {
    background: rgba(74, 74, 107, 0.3); /* Lighter background */
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    border-left: 4px solid #FFD700;
}

.unit-info .lore-text {
    font-style: italic;
    color: #E8E8FF; /* Lighter text color */
    margin-top: 10px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 5px;
}

.planned-updates-button {
    background: #8B4513 !important; /* Wood brown color */
    border: 3px solid #654321 !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    margin-top: 20px !important;
    position: relative;
    overflow: hidden;
}

.planned-updates-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, 
        rgba(139, 69, 19, 0.6) 25%, 
        rgba(160, 82, 45, 0.6) 25%, 
        rgba(160, 82, 45, 0.6) 50%, 
        rgba(139, 69, 19, 0.6) 50%, 
        rgba(139, 69, 19, 0.6) 75%, 
        rgba(160, 82, 45, 0.6) 75%);
    background-size: 20px 20px;
}

#plannedUpdatesModal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #8B4513; /* Wood brown */
    padding: 30px;
    border-radius: 10px;
    border: 8px solid #654321; /* Darker wood brown */
    z-index: 1000;
    max-width: 600px;
    width: 90%;
    color: #FFE4B5; /* Moccasin - light woody color */
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    background-image: 
        linear-gradient(45deg, 
        rgba(139, 69, 19, 0.4) 25%, 
        rgba(160, 82, 45, 0.4) 25%, 
        rgba(160, 82, 45, 0.4) 50%, 
        rgba(139, 69, 19, 0.4) 50%, 
        rgba(139, 69, 19, 0.4) 75%, 
        rgba(160, 82, 45, 0.4) 75%);
    background-size: 20px 20px;
}

#plannedUpdatesModal h2 {
    color: #FFD700;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    border-bottom: 3px solid #654321;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

#plannedUpdatesModal ul {
    list-style: none;
    padding: 0;
}

#plannedUpdatesModal li {
    padding: 10px;
    margin: 5px 0;
    background: rgba(101, 67, 33, 0.5);
    border-radius: 5px;
    border-left: 4px solid #FFD700;
}

#plannedUpdatesModal .close-button {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    color: #FFE4B5;
    cursor: pointer;
    font-size: 20px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

#plannedUpdatesModal .close-button:hover {
    color: #FFD700;
}

@keyframes floatUp {
    0% {
        transform: translateY(0);
        opacity: 1;
    }
    100% {
        transform: translateY(-20px);
        opacity: 0;
    }
}

@keyframes dodge {
    0% { transform: translateY(0); }
    50% { transform: translateY(-30px); }
    100% { transform: translateY(0); }
}

.dodging {
    animation: dodge 0.5s ease-out;
}

@keyframes jump {
    0% { transform: translateY(0); }
    50% { transform: translateY(-50px); }
    100% { transform: translateY(0); }
}

.jumping {
    animation: jump 0.8s ease-out;
}

@keyframes swing {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.hammer-swing {
    background-image: url('hammer swing.gif') !important; /* Add !important */
    transform-origin: center;
    animation: swing 0.5s ease-out;
}

.loot-box-opening {
    animation: boxOpen 0.5s ease-out;
}

/* Add CSS for powered up plumbers */
.player-unit.redPlumber.super {
    transform: scale(1.5);
    filter: brightness(1.2);
}

.player-unit.greenPlumber.super {
    transform: scale(1.5);
    filter: brightness(1.2);
}

@keyframes powerUp {
    0% { transform: scale(1); }
    50% { transform: scale(1.6); }
    100% { transform: scale(1.5); }
}

.powering-up {
    animation: powerUp 0.5s ease-out forwards;
}

/* Add styles for secret menu */
#secretMenu {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #1B2B65;
    padding: 30px;
    border-radius: 10px;
    border: 4px solid #8B4513;
    z-index: 1001;
    width: 80%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

#secretMenu::-webkit-scrollbar {
    width: 12px;
}

#secretMenu::-webkit-scrollbar-track {
    background: rgba(139, 69, 19, 0.2);
    border-radius: 6px;
}

#secretMenu::-webkit-scrollbar-thumb {
    background: #8B4513;
    border-radius: 6px;
    border: 2px solid #654321;
}

#secretMenu::-webkit-scrollbar-thumb:hover {
    background: #654321;
}
</style>
</head>
<body>
<div id="mainMenu" style="display: flex;">
    <div style="max-width: 800px; margin: 0 auto; text-align: center;">
        <img src="menu new.png" alt="Tower Defense Battle" class="menu-logo">
        <div class="bux-display" style="margin: 20px 0; display: flex; align-items: center; justify-content: center; gap: 10px; background: rgba(74, 74, 107, 0.5); padding: 10px; border-radius: 10px; display: inline-flex;">
            <img src="bux.png" style="width: 32px; height: 32px; image-rendering: pixelated;">
            <span style="color: #FFD700; font-size: 24px;">0</span>
        </div>
        <div style="display: flex; flex-direction: column; gap: 20px; align-items: center; margin-top: 20px;">
            <button id="startGameButton" style="background: #4CAF50; padding: 15px 30px; font-size: 24px; border: none; color: white; cursor: pointer; border-radius: 5px;">Start Game</button>
        </div>
        <div class="game-mode-selector">
            <h2>Select Game Mode:</h2>
            <div class="mode-buttons">
                <button class="mode-button selected" data-mode="classic">
                    Classic Mode
                    <span class="mode-description">Standard tower defense battle</span>
                </button>
                <button class="mode-button" data-mode="survival">
                    Survival Mode
                    <span class="mode-description">Endless waves with increasing difficulty</span>
                </button>
                <button class="mode-button" data-mode="rush">
                    Rush Mode
                    <span class="mode-description">Double gold, double speed!</span>
                </button>
                <button class="mode-button" data-mode="zombie">
                    Zombie Mode
                    <span class="mode-description">Face endless waves of zombies!</span>
                </button>
            </div>
        </div>
        <div class="store-section">
            <h2>Store</h2>
            <div class="store-container">
                <button class="store-item" onclick="game.purchaseUnit('archer')">
                    <img src="player unit archer not moving.png" alt="Archer">
                    Archer
                    <div class="store-item-price">
                        <img src="bux.png" alt="Bux">
                        <span>10</span>
                    </div>
                </button>
                <button class="store-item" onclick="game.purchaseUnit('knight')">
                    <img src="knight.png" alt="Knight">
                    Knight
                    <div class="store-item-price">
                        <img src="bux.png" alt="Bux">
                        <span>15</span>
                    </div>
                </button>
                <button class="store-item" onclick="game.purchaseUnit('wizard')">
                    <img src="player unit wizard.gif" alt="Wizard">
                    Wizard
                    <div class="store-item-price">
                        <img src="bux.png" alt="Bux">
                        <span>25</span>
                    </div>
                </button>
                <button class="store-item" onclick="game.purchaseUnit('alien')">
                    <img src="player unit alien WITH a laser gun.gif" alt="Alien">
                    Alien
                    <div class="store-item-price">
                        <img src="bux.png" alt="Bux">
                        <span>30</span>
                    </div>
                </button>
                <button class="store-item" onclick="game.purchaseUnit('oldMan')">
                    <img src="player unit, old man.gif" alt="Old Man">
                    Old Man
                    <div class="store-item-price">
                        <img src="bux.png" alt="Bux">
                        <span>35</span>
                    </div>
                </button>
                <button class="store-item" onclick="game.purchaseUnit('goblin')">
                    <img src="goblin unit player.gif" alt="Goblin">
                    Goblin
                    <div class="store-item-price">
                        <img src="bux.png" alt="Bux">
                        <span>20</span>
                    </div>
                </button>
            </div>
        </div>
        <div style="margin-top: 20px;">
            <button id="howToPlayButton" style="background: #2196F3; padding: 15px 30px; font-size: 24px; border: none; color: white; cursor: pointer; border-radius: 5px;">How to Play</button>
        </div>
        <div style="margin-top: 20px;">
            <button id="infoButton" style="background: #FF9800; padding: 15px 30px; font-size: 24px; border: none; color: white; cursor: pointer; border-radius: 5px;">Game Info</button>
        </div>
        <div style="margin-top: 20px;">
            <button id="plannedUpdatesButton" class="planned-updates-button" style="background: #FF9800; padding: 15px 30px; font-size: 24px; border: none; color: white; cursor: pointer; border-radius: 5px;">Planned Updates</button>
        </div>
    </div>
</div>
<div id="gameContainer">
    <div id="resources">Gold: <span id="goldAmount">150</span>
        <span style="margin-left: 20px; display: flex; align-items: center; gap: 5px;">
            <img src="bux.png" style="width: 24px; height: 24px;"> 
            <span id="buxAmount">0</span>
        </span>
    </div>
    <div id="unitSelection">
        <button class="unit-button" data-cost="20" data-unit="soldier">Soldier (20g)</button>
        <button class="unit-button" data-cost="80" data-unit="fencer">Fencer (80g)</button>
        <button class="unit-button locked" data-cost="50" data-unit="archer">Archer (50g)</button>
        <button class="unit-button locked" data-cost="100" data-unit="knight">Knight (100g)</button>
        <button class="unit-button locked" data-cost="150" data-unit="wizard">Wizard (150g)</button>
        <button class="unit-button locked" data-cost="75" data-unit="goblin">Goblin (75g)</button>
        <button class="unit-button locked" data-cost="200" data-unit="oldMan">Old Man (200g)</button>
        <button class="unit-button locked" data-cost="175" data-unit="alien">Alien (175g)</button>
        <button class="unit-button locked" data-cost="125" data-unit="derpbot">Derpbot (125g)</button>
        <button class="unit-button" data-cost="150" data-unit="redPlumber">Red Plumber (150g)</button>
        <button class="unit-button locked" data-cost="50" data-unit="miniDerpbot">Mini Derpbot (50g)</button>
        <button class="unit-button" data-cost="65" data-unit="mushroom">Mushroom (65g)</button>
        <button class="unit-button" data-cost="90" data-unit="hammer">Hammer (90g)</button>
        <button class="unit-button" data-cost="0" data-unit="zombie">Zombie (0g)</button>
    </div>
    <div id="battlefield">
        <div id="playerBase" class="base">Base
            <div class="health-bar"></div>
        </div>
        <div id="enemyBase" class="base">Enemy
            <div class="health-bar"></div>
        </div>
        <div id="winScreen" class="game-over-screen win-screen">
            <div class="game-over-text">Victory!</div>
            <div class="new-unit-unlock">New unit unlocked!</div>
            <div class="button-container">
                <button id="retryButton">Keep Fighting</button>
                <button id="backToMenuButton">Back to Menu</button>
                <button id="nextBattleButton">Next Battle</button>
            </div>
        </div>
        <div id="loseScreen" class="game-over-screen lose-screen">
            <div class="game-over-text">Defeat!</div>
            <div class="button-container">
                <button id="retryButtonLose">Try Again</button>
                <button id="backToMenuLoseButton">Back to Menu</button>
            </div>
        </div>
    </div>
    <div id="helpTooltip">
        <button class="close-button">&times;</button>
        <h2>How to Unlock Units</h2>
        <p>Start with the basic Soldier unit (20 gold)</p>
        <p>Win a battle to unlock the Archer unit (50 gold)</p>
        <p>Win another battle to unlock the Knight unit (100 gold)</p>
        <p>Win yet another battle to unlock the Wizard unit (150 gold)</p>
        <p>Press 'H' again or click X to close this help window</p>
    </div>
</div>
<div id="howToPlayModal">
    <button class="close-button">&times;</button>
    <h2>How to Play</h2>
    <div style="text-align: left;">
        <h3>Basic Controls:</h3>
        <ul>
            <li>Click unit buttons to spawn units</li>
            <li>Press 'H' for unit unlock information</li>
            <li>Defend your base while attacking the enemy</li>
        </ul>
        <h3>Units:</h3>
        <ul>
            <li>Soldier: Basic melee unit (20 gold)</li>
            <li>Fencer: Agile warrior with a dodge ability (80 gold)</li>
            <li>Archer: Ranged unit that stops midfield (50 gold)</li>
            <li>Knight: Strong melee unit (100 gold)</li>
            <li>Wizard: Powerful magic unit (150 gold)</li>
            <li>Goblin: Fast melee unit (75 gold)</li>
            <li>Old Man: Powerful sage (200 gold)</li>
            <li>Alien: Mysterious warrior with advanced technology (175 gold)</li>
            <li>Red Plumber: Acrobatic unit that spawns a Green Plumber (150 gold)</li>
            <li>Mini Derpbot: Quick mechanical unit (50 gold)</li>
            <li>Mushroom: Agile fungal warrior (65 gold)</li>
            <li>Hammer: Strong melee unit with powerful swing attacks (90 gold)</li>
            <li>Zombie: Slow but durable unit (0 gold)</li>
        </ul>
    </div>
</div>
<div id="infoModal">
    <button class="close-button">&times;</button>
    <h2>Game Information</h2>
    
    <div class="info-section">
        <h3>The World of Battle Guys</h3>
        <div class="lore-section">
            <p>In a realm where magic and might clash endlessly, two ancient castles face each other across a contested battlefield. The Blue Kingdom, defenders of peace and prosperity, stand resolute against the forces of the Red Legion, who seek to spread chaos and destruction.</p>
            <p>For centuries, these opposing forces have engaged in tactical warfare, each side commanding unique warriors and wielding powerful magic. The battlefield between them has become a legendary ground where heroes rise and fall, where mighty wizards cast their spells, and where the fate of the realm hangs in the balance.</p>
            <p>As commander of the Blue Kingdom's forces, you must utilize your strategic wisdom to deploy your units effectively, unlock powerful new allies, and ultimately triumph over the relentless Red Legion.</p>
        </div>
    </div>

    <div class="info-section">
        <h3>Player Units</h3>
        <div class="info-grid">
            <div class="unit-info">
                <h4>Soldier (20g)</h4>
                <div class="unit-image" style="background-image: url('player unit.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 70</p>
                    <p>Damage: 15</p>
                    <p>Speed: Normal</p>
                </div>
                <div class="lore-text">
                    Trained in the prestigious Blue Kingdom Military Academy, these loyal warriors form the backbone of your army. Each soldier takes a sacred oath to protect the realm, equipped with enchanted blue armor that resonates with their unwavering spirit.
                </div>
            </div>

            <div class="unit-info">
                <h4>Fencer (80g)</h4>
                <div class="unit-image" style="background-image: url('player unit fencer.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 90</p>
                    <p>Damage: 30</p>
                    <p>Speed: Fast</p>
                    <p>Special: 40% Dodge Chance</p>
                </div>
                <div class="lore-text">
                    Masters of the blade, these agile warriors have trained in the ancient art of sword dancing. Their fluid movements and lightning-fast reflexes allow them to dodge incoming attacks with graceful precision, making them formidable duelists on the battlefield.
                </div>
            </div>

            <div class="unit-info">
                <h4>Archer (50g)</h4>
                <div class="unit-image" style="background-image: url('player unit archer.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 45</p>
                    <p>Damage: 20</p>
                    <p>Range: Long</p>
                </div>
                <div class="lore-text">
                    Members of the legendary Azure Bowmen, these skilled marksmen train in the mystical Moonlight Forest. Their arrows are blessed by ancient magic, allowing them to strike with supernatural accuracy.
                </div>
            </div>

            <div class="unit-info">
                <h4>Knight (100g)</h4>
                <div class="unit-image" style="background-image: url('knight.png')"></div>
                <div class="unit-stats">
                    <p>Health: 150</p>
                    <p>Damage: 40</p>
                    <p>Speed: Slow</p>
                </div>
                <div class="lore-text">
                    The elite Royal Guards of the Blue Kingdom, these knights undergo decades of training while wearing increasingly heavy enchanted armor. Their exceptional strength and resolve make them nearly unstoppable on the battlefield.
                </div>
            </div>

            <div class="unit-info">
                <h4>Wizard (150g)</h4>
                <div class="unit-image" style="background-image: url('player unit wizard.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 80</p>
                    <p>Damage: 35</p>
                    <p>Speed: Medium</p>
                </div>
                <div class="lore-text">
                    Graduates of the Crystal Tower Academy, these master spellcasters have devoted their lives to studying the ancient arts. Each wizard carries a staff infused with pure celestial energy, channeling powerful battle magic.
                </div>
            </div>

            <div class="unit-info">
                <h4>Goblin (75g)</h4>
                <div class="unit-image" style="background-image: url('goblin unit player.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 60</p>
                    <p>Damage: 25</p>
                    <p>Speed: Fast</p>
                </div>
                <div class="lore-text">
                    Once enemies of the Blue Kingdom, these reformed goblins pledged allegiance after being shown mercy and kindness. Their natural agility and cunning now serve as valuable assets to your forces.
                </div>
            </div>
            
            <div class="unit-info">
                <h4>Old Man (200g)</h4>
                <div class="unit-image" style="background-image: url('player unit, old man.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 300</p>
                    <p>Damage: 60</p>  
                    <p>Speed: 1.2</p>
                </div>
                <div class="lore-text">
                    Once the Grand Master of the Crystal Tower Academy, this ancient sage now fights on the frontlines. His years of combat experience and mastery of ancient fighting techniques make him one of the most formidable warriors in the Blue Kingdom. He has a unique ability to empower nearby allies, enhancing their strength in battle.
                </div>
            </div>

            <div class="unit-info">
                <h4>Alien (175g)</h4>
                <div class="unit-image" style="background-image: url('player unit alien WITH a laser gun.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 120</p>
                    <p>Damage: 45</p>
                    <p>Speed: Fast</p>
                    <p>Special: Rapid-fire laser shots</p>
                </div>
                <div class="lore-text">
                    A mysterious visitor from beyond the stars who allied with the Blue Kingdom after witnessing their noble cause. Armed with advanced technology, this alien warrior's laser weaponry proves devastatingly effective against the forces of darkness.
                </div>
            </div>

            <div class="unit-info">
                <h4>Derpbot (125g)</h4>
                <div class="unit-image" style="background-image: url('player tall derpbot.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 200</p>
                    <p>Damage: 45</p>
                    <p>Speed: Fast</p>
                </div>
                <div class="lore-text">
                    A mysterious mechanical warrior that combines ancient magic with advanced technology. Originally created by an unknown civilization, these automatons were discovered dormant in ancient ruins. While the enemy forces managed to corrupt some derbbots to their cause, the Blue Kingdom has learned to reprogram captured units to fight for justice.
                </div>
            </div>

            <div class="unit-info">
                <h4>Mini Derpbot (50g)</h4>
                <div class="unit-image" style="background-image: url('player mini derpbot.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 60</p>
                    <p>Damage: 20</p>
                    <p>Speed: Fast</p>
                </div>
                <div class="lore-text">
                    A smaller, more agile version of the standard derpbot. While not as durable as their larger counterparts, these nimble mechanical warriors make up for it with increased speed and maneuverability. Perfect for quick strikes and harassment tactics.
                </div>
            </div>

            <div class="unit-info">
                <h4>Red Plumber (150g)</h4>
                <div class="unit-image" style="background-image: url('red plumber unit.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 100</p>
                    <p>Damage: 25</p>
                    <p>Speed: Fast</p>
                    <p>Special: Spawns Green Plumber companion, both can jump over enemies</p>
                </div>
                <div class="lore-text">
                    A skilled adventurer known for his acrobatic abilities and loyal partnership with his green-clad companion. Together, they use their incredible jumping skills to overcome any obstacle in their path.
                </div>
            </div>

            <div class="unit-info">
                <h4>Green Plumber (Companion)</h4>
                <div class="unit-image" style="background-image: url('green plumber unit.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 90</p>
                    <p>Damage: 20</p>
                    <p>Speed: Very Fast</p>
                    <p>Special: Can jump over enemies</p>
                </div>
                <div class="lore-text">
                    The loyal companion to the Red Plumber, slightly more timid but equally skilled. His jumping abilities and unwavering dedication make him an invaluable ally in battle.
                </div>
            </div>

            <div class="unit-info">
                <h4>Mushroom (65g)</h4>
                <div class="unit-image" style="background-image: url('player mushroom unit.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 80</p>
                    <p>Damage: 30</p>
                    <p>Speed: Fast</p>
                </div>
                <div class="lore-text">
                    These curious fungal warriors bounce into battle with surprising agility. While not the strongest unit, their speed and resilience make them effective scout troops for both armies.
                </div>
            </div>

            <div class="unit-info">
                <h4>Hammer (90g)</h4>
                <div class="unit-image" style="background-image: url('hammer unit player.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 110</p>
                    <p>Damage: 35</p>
                    <p>Speed: 1.5</p>
                    <p>Special: Powerful swing attack with bonus damage</p>
                </div>
                <div class="lore-text">
                    Trained in the ancient art of hammer combat, these warriors wield massive hammers enchanted with earth-shaking power. Their mighty swings can devastate multiple enemies at once, making them excellent front-line fighters.
                </div>
            </div>

            <div class="unit-info">
                <h4>Zombie (0g)</h4>
                <div class="unit-image" style="background-image: url('enemy zombie.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 90</p>
                    <p>Damage: 25</p>
                    <p>Speed: 1.2</p>
                    <p>Special: Converts defeated enemies into zombies</p>
                </div>
                <div class="lore-text">
                    These shambling undead warriors possess the uncanny ability to spread their affliction to those they defeat in battle. When a zombie defeats an enemy unit, that unit rises again as a new zombie, slowly building an unstoppable horde of the undying. Their very presence strikes fear into the hearts of both armies.
                </div>
            </div>
        </div>

        <h3>Enemy Units</h3>
        <div class="info-grid">
            <div class="unit-info">
                <h4>Evil Wizard</h4>
                <div class="unit-image" style="background-image: url('EVILLL wizard.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 200</p>
                    <p>Damage: 15</p>
                    <p>Special: Spawns Skeletons</p>
                </div>
                <div class="lore-text">
                    Corrupted former members of the Crystal Tower Academy who were seduced by forbidden magic. These dark sorcerers can raise the dead to fight alongside them, making them particularly dangerous foes.
                </div>
            </div>

            <div class="unit-info">
                <h4>Skeleton</h4>
                <div class="unit-image" style="background-image: url('skeleton.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 40</p>
                    <p>Damage: 10</p>
                    <p>Speed: Medium</p>
                </div>
                <div class="lore-text">
                    The reanimated remains of fallen warriors, bound to serve the Evil Wizards. Though individually weak, their numbers can quickly overwhelm the unprepared.
                </div>
            </div>

            <div class="unit-info">
                <h4>Rock Boss</h4>
                <div class="unit-image" style="background-image: url('flying rock boss.png')"></div>
                <div class="unit-stats">
                    <p>Health: 500</p>
                    <p>Damage: 50</p>
                    <p>Speed: Very Slow</p>
                </div>
                <div class="lore-text">
                    Ancient guardians awakened by the Red Legion's dark magic. These massive animated boulders were once part of the mountain that housed the oldest temples of the realm. Now corrupted, they serve as devastating siege weapons.
                </div>
            </div>

            <div class="unit-info">
                <h4>Enemy Soldier</h4>
                <div class="unit-image" style="background-image: url('enemy unit.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 70</p>
                    <p>Damage: 15</p>
                    <p>Speed: Normal</p>
                </div>
                <div class="lore-text">
                    The frontline troops of the Red Legion, these corrupted warriors have pledged their souls to dark powers. Their crimson armor is forged in the fires of chaos, and they fight with ruthless determination.
                </div>
            </div>

            <div class="unit-info">
                <h4>Enemy Fencer</h4>
                <div class="unit-image" style="background-image: url('enemy unit fencer.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 90</p>
                    <p>Damage: 30</p>
                    <p>Speed: Fast</p>
                </div>
                <div class="lore-text">
                    Once noble duelists who fell to the temptation of forbidden combat techniques. These corrupted fencers now use their exceptional skills to serve the Red Legion, their movements unnaturally swift and deadly.
                </div>
            </div>

            <div class="unit-info">
                <h4>Enemy Knight</h4>
                <div class="unit-image" style="background-image: url('enemy knight.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 150</p>
                    <p>Damage: 40</p>
                    <p>Speed: Slow</p>
                </div>
                <div class="lore-text">
                    Former champions of justice who have fallen to darkness. Their once-gleaming armor is now stained with the corruption of the Red Legion, and they use their considerable martial prowess to crush all who stand in their path.
                </div>
            </div>

            <div class="unit-info">
                <h4>Derpbot</h4>
                <div class="unit-image" style="background-image: url('enemy tall derpbot.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 200</p>
                    <p>Damage: 45</p>
                    <p>Speed: Fast</p>
                </div>
                <div class="lore-text">
                    A corrupted version of the mechanical warriors that now serve the Red Legion. These derpbots have been reprogrammed to fight against the Blue Kingdom, utilizing their advanced technology to unleash devastating attacks.
                </div>
            </div>

            <div class="unit-info">
                <h4>Mini Derpbot</h4>
                <div class="unit-image" style="background-image: url('enemy mini derpbot.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 60</p>
                    <p>Damage: 20</p>
                    <p>Speed: Fast</p>
                </div>
                <div class="lore-text">
                    A smaller version of the derpbot, these units are quick and agile, making them difficult to hit in battle. Their speed allows them to flank enemies and strike at weak points.
                </div>
            </div>

            <div class="unit-info">
                <h4>Mushroom</h4>
                <div class="unit-image" style="background-image: url('enemy mushroom unit.gif')"></div>
                <div class="unit-stats">
                    <p>Health: 80</p>
                    <p>Damage: 30</p>
                    <p>Speed: Fast</p>
                </div>
                <div class="lore-text">
                    Agile fungal warriors that bounce into battle with surprising speed. They are known for their resilience, making them effective scouts on the battlefield.
                </div>
            </div>

            <div class="unit-info">
                <h4>Zombie</h4>
                <div class="unit-image" style="background-image: url('zombie.png')"></div>
                <div class="unit-stats">
                    <p>Health: 90</p>
                    <p>Damage: 25</p>
                    <p>Speed: 1.2</p>
                </div>
                <div class="lore-text">
                    Once the citizens of the fallen kingdom, these slow-moving undead creatures now serve the Red Legion. Their relentless march toward the enemy can easily overwhelm unprepared defenses.
                </div>
            </div>
        </div>
    </div>
</div>
<div id="plannedUpdatesModal">
    <button class="close-button">&times;</button>
    <h2>🔨 Planned Updates</h2>
    <ul>
        <li>🎨 New logo that's good lol</li>
        <li>👨‍🚀 SUSpicious spaceman unit</li>
        <li>🌐 Online mode (won't be soon)</li>
        <li>🧟‍♂️ Player version of the zombie</li>
        <li>🧽 SpongeRob unit</li>
        <li>🤖 More derpbots</li>
        <li><span id="secretMenuTrigger" style="cursor: pointer; text-decoration: underline;">❓ and more..</span></li>
    </ul>
</div>

<div id="secretMenu" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1B2B65; padding: 30px; border-radius: 10px; border: 4px solid #8B4513; z-index: 1001; width: 80%; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
    <button class="close-button" style="position: sticky; top: 0; float: right; background: none; border: none; color: white; cursor: pointer; font-size: 20px;">&times;</button>
    <h2 style="color: #FFD700; margin-top: 0; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Secret Unused Content</h2>
    <div class="secret-store-container" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; padding: 20px;">
        <div class="unused-unit-card" style="background: rgba(74, 74, 107, 0.5); padding: 20px; border-radius: 10px; width: 100%; margin-bottom: 15px;">
            <h3 style="color: #FFD700; margin-top: 0;">The Rapper Unit</h3>
            <div style="display: flex; align-items: center; gap: 20px; margin: 15px 0;">
                <img src="unused unit &quot;rapper&quot;.png" style="width: 80px; height: 80px; image-rendering: pixelated;">
                <div style="flex-grow: 1;">
                    <p style="color: #E8E8FF; font-style: italic; margin: 0;">
                        "When I was making the hammer unit I was going to make the hammer tiny then I thought it looked like a microphone then I made this... no idea he would do any ways.."
                    </p>
                </div>
            </div>
            <div style="font-size: 14px; color: #888; text-align: right;">
                - Developer Notes
            </div>
        </div>
        
        <div class="unused-unit-card" style="background: rgba(74, 74, 107, 0.5); padding: 20px; border-radius: 10px; width: 100%; margin-bottom: 15px;">
            <h3 style="color: #FFD700; margin-top: 0;">The Slim Jim Unit</h3>
            <div style="display: flex; align-items: center; gap: 20px; margin: 15px 0;">
                <img src="unused unit &quot;slim jim&quot;.png" style="width: 80px; height: 80px; image-rendering: pixelated;">
                <div style="flex-grow: 1;">
                    <p style="color: #E8E8FF; font-style: italic; margin: 0;">
                        "He was gonna be a boss at some point who would tp and one shot things so yeah..."
                    </p>
                </div>
            </div>
            <div style="font-size: 14px; color: #888; text-align: right;">
                - Developer Notes
            </div>
        </div>

        <div class="unused-unit-card" style="background: rgba(74, 74, 107, 0.5); padding: 20px; border-radius: 10px; width: 100%; margin-bottom: 15px;">
            <h3 style="color: #FFD700; margin-top: 0;">Ravioli Pepperoni</h3>
            <div style="display: flex; align-items: center; gap: 20px; margin: 15px 0;">
                <img src="no pic for unit.png" style="width: 80px; height: 80px; image-rendering: pixelated;">
                <div style="flex-grow: 1;">
                    <p style="color: #E8E8FF; font-style: italic; margin: 0;">
                        "This one would have been a reference to Pizza Tower he would have been fast and have a dash move the only reason I didn't add him was because I cant draw a chefs hat for him.."
                    </p>
                </div>
            </div>
            <div style="font-size: 14px; color: #888; text-align: right;">
                - Developer Notes
            </div>
        </div>

        <div class="unused-unit-card" style="background: rgba(74, 74, 107, 0.5); padding: 20px; border-radius: 10px; width: 100%; margin-bottom: 15px;">
            <h3 style="color: #FFD700; margin-top: 0;">The Blue Plumber Unit</h3>
            <div style="display: flex; align-items: center; gap: 20px; margin: 15px 0;">
                <img src="blue plumber unused.png" style="width: 80px; height: 80px; image-rendering: pixelated;">
                <div style="flex-grow: 1;">
                    <p style="color: #E8E8FF; font-style: italic; margin: 0;">
                        "This one is a reference to smg4 I didn't add him because I don't know what he should do.."
                    </p>
                </div>
            </div>
            <div style="font-size: 14px; color: #888; text-align: right;">
                - Developer Notes
            </div>
        </div>
    </div>
</div>

<script>
class Game {
    constructor() {
        this.bux = parseInt(localStorage.getItem('bux')) || 0;
        this.updateMainMenuBux();
        this.gold = 150; // Changed from 100
        this.playerBaseHealth = 100;
        this.enemyBaseHealth = 100;
        this.units = [];
        this.arrows = [];
        this.enemySpawnInterval = null;
        this.unlockedUnits = ['soldier', 'fencer', 'redPlumber', 'mushroom', 'hammer'];
        this.defeatedDerpbot = false; // Add this flag
        this.defeatedMiniDerpbot = false; // Add this flag
        this.gameMode = 'classic';
        this.wave = 1;
        this.survivalInterval = null;
        this.rockBossSpawned = false; // Added property

        // Add mode-specific settings
        this.modeSettings = {
            classic: {
                goldRate: 2,
                enemySpawnRate: 4000,
                baseHealth: 100,
                goldMultiplier: 1,
                speedMultiplier: 1
            },
            survival: {
                goldRate: 3,
                enemySpawnRate: 3000,
                baseHealth: 150,
                goldMultiplier: 1.2,
                speedMultiplier: 1
            },
            rush: {
                goldRate: 4,
                enemySpawnRate: 2000,
                baseHealth: 80,
                goldMultiplier: 2,
                speedMultiplier: 1.5
            },
            zombie: {
                goldRate: 3,
                enemySpawnRate: 2000, // Faster zombie spawns
                baseHealth: 120,
                goldMultiplier: 1.5,
                speedMultiplier: 1
            }
        };

        this.unitStats = {
            soldier: { 
                health: 70, 
                damage: 15, 
                speed: 2, 
                cost: 20,
                targetPosition: null // add this
            },
            fencer: {
                health: 90,
                damage: 30,
                speed: 2,
                cost: 80,
                dodgeChance: 0.4, // 40% chance to dodge
                targetPosition: null,
                lastDodge: 0,
                dodgeCooldown: 2000 // 2 seconds between possible dodges
            },
            archer: { 
                health: 45, 
                damage: 20, 
                speed: 1, 
                cost: 50, 
                range: 200, 
                attackSpeed: 1000,
                targetPosition: {
                    player: 400,
                    enemy: 400
                }
            },
            knight: { 
                health: 150, 
                damage: 40, 
                speed: 1, 
                cost: 100,
                targetPosition: null // add this
            },
            wizard: { 
                health: 80, 
                damage: 35, 
                speed: 1.5, 
                cost: 150,
                targetPosition: null  // Remove the target position to make wizard keep walking
            },
            goblin: {
                health: 60,
                damage: 25,
                speed: 3, // Fast unit
                cost: 75,
                targetPosition: null
            },
            alien: {
                health: 120,
                damage: 45,
                speed: 1.2,
                cost: 175,
                range: 250,
                attackSpeed: 800, // Faster attack speed than archer
                targetPosition: {
                    player: 350,
                    enemy: 350
                }
            },
            derpbot: {
                health: 200,
                damage: 45,
                speed: 1.5,
                cost: 125,
                targetPosition: null
            },
            miniDerpbot: {
                health: 60,
                damage: 20,
                speed: 3, // Faster than regular derpbot
                cost: 50,
                targetPosition: null
            },
            redPlumber: {
                health: 100,
                damage: 25,
                speed: 1.8,
                cost: 150,
                jumpChance: 0.3, // 30% chance to jump
                lastJump: 0,
                jumpCooldown: 2000, // 2 seconds between possible jumps
                isSuper: false, // Track powered up state
                targetPosition: null
            },
            greenPlumber: {
                health: 90,
                damage: 20,
                speed: 2,
                jumpChance: 0.3,
                lastJump: 0,
                jumpCooldown: 2000,
                isSuper: false, // Track powered up state
                targetPosition: null
            },
            mushroom: {
                health: 80,
                damage: 30,
                speed: 2.5,
                cost: 65,
                targetPosition: null
            },
            hammer: {
                health: 110,
                damage: 35,
                speed: 1.5,
                cost: 90,
                swingCooldown: 2000, // 2 seconds between swings
                swingDuration: 500, // Swing animation duration 
                isSwinging: false, // Track swing state
                targetPosition: null
            },
            evilWizard: {
                health: 200,
                damage: 15,
                speed: 0.5, // Very slow
                spawnInterval: 3000, // Spawn skeleton every 3 seconds
                targetPosition: null
            },
            skeleton: {
                health: 40,
                damage: 10,
                speed: 1.5,
                targetPosition: null
            },
            rockBoss: {
                health: 500,
                damage: 50,
                speed: 0.3, // Very slow
                spawnInterval: 5000, // Spawn rocks every 5 seconds
                targetPosition: null
            },
            oldMan: {
                health: 300,
                damage: 60,
                speed: 1.2, // Increased from 0.8
                cost: 200,
                targetPosition: null,
                buffRadius: 150, // Radius for buffing nearby units
                buffInterval: 2000, // Buff every 2 seconds
                buffMultiplier: 1.5 // Damage multiplier for buffed units
            },
            zombie: {
                health: 90,
                damage: 25, 
                speed: 1.2,
                cost: 0, // Enemy unit, so no cost
                targetPosition: null
            },
            enemySoldier: {
                health: 70,
                damage: 15,
                speed: 2,
                cost: 0
            },
            enemyFencer: {
                health: 90,
                damage: 30,
                speed: 2,
                cost: 0
            },
            enemyKnight: {
                health: 150,
                damage: 40,
                speed: 1,
                cost: 0
            },
            enemyMiniDerpbot: {
                health: 60,
                damage: 20,
                speed: 3,
                cost: 0,
                targetPosition: null
            },
            enemyMushroom: {
                health: 80,
                damage: 30,
                speed: 2.5,
                targetPosition: null
            }
        };
        this.level = 1;

        this.setupMainMenu();
        this.setupEventListeners();
        this.setupHelpSystem();
        this.updateUI();
        this.startEnemySpawner();

        // Start the game loop immediately
        this.gameLoop = setInterval(() => {
            this.updateUnits();
            const settings = this.modeSettings[this.gameMode];
            this.gold += settings.goldRate;
            this.updateUI();
        }, 50);
    }

    loadBux() {
        this.bux = parseInt(localStorage.getItem('bux')) || 0;
        this.updateMainMenuBux();
    }

    updateMainMenuBux() {
        const mainMenuBuxDisplay = document.querySelector('#mainMenu .bux-display');
        if (mainMenuBuxDisplay) {
            mainMenuBuxDisplay.querySelector('span').textContent = this.bux;
        }
    }

    setupMainMenu() {
        const startButton = document.getElementById('startGameButton');
        const howToPlayButton = document.getElementById('howToPlayButton');
        const infoButton = document.getElementById('infoButton');
        const plannedUpdatesButton = document.getElementById('plannedUpdatesButton');
        const mainMenu = document.getElementById('mainMenu');
        const gameContainer = document.getElementById('gameContainer');
        const plannedUpdatesModal = document.getElementById('plannedUpdatesModal');

        // Load bux when showing main menu
        startButton.addEventListener('click', () => {
            this.loadBux(); // Load bux when starting game
            mainMenu.style.display = 'none';
            gameContainer.style.display = 'block';
            // Clear any existing intervals before resetting
            if (this.enemySpawnInterval) {
                clearInterval(this.enemySpawnInterval);
            }
            this.resetGame(true); // Start fresh game but keep unlocks
        });
        
        howToPlayButton.addEventListener('click', () => {
            howToPlayModal.style.display = 'block';
        });

        infoButton.addEventListener('click', () => {
            infoModal.style.display = 'block';
        });

        plannedUpdatesButton.addEventListener('click', () => {
            plannedUpdatesModal.style.display = 'block';
        });
        
        document.querySelectorAll('#howToPlayModal .close-button').forEach(button => {
            button.addEventListener('click', () => {
                howToPlayModal.style.display = 'none';
            });
        });

        document.querySelectorAll('#infoModal .close-button').forEach(button => {
            button.addEventListener('click', () => {
                infoModal.style.display = 'none';
            });
        });

        document.querySelector('#plannedUpdatesModal .close-button').addEventListener('click', () => {
            plannedUpdatesModal.style.display = 'none';
        });

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === infoModal) {
                infoModal.style.display = 'none';
            } else if (event.target === plannedUpdatesModal) {
                plannedUpdatesModal.style.display = 'none';
            }
        });

        // Add mode selection
        document.querySelectorAll('.mode-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.mode-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                button.classList.add('selected');
                this.setGameMode(button.dataset.mode);
            });
        });
    }

    setGameMode(mode) {
        this.gameMode = mode;
        const settings = this.modeSettings[mode];
        
        // Apply mode-specific settings
        this.playerBaseHealth = settings.baseHealth;
        this.enemyBaseHealth = settings.baseHealth;
        
        // Update unit speeds
        Object.keys(this.unitStats).forEach(unit => {
            this.unitStats[unit].speed *= settings.speedMultiplier;
        });
        
        // Clear any existing intervals
        if (this.survivalInterval) {
            clearInterval(this.survivalInterval);
        }
        
        // Set up survival mode specific logic
        if (mode === 'survival') {
            this.survivalInterval = setInterval(() => {
                this.wave++;
                this.enemyBaseHealth += 20;
                this.modeSettings.survival.enemySpawnRate = Math.max(
                    1000,
                    this.modeSettings.survival.enemySpawnRate - 100
                );
                this.startEnemySpawner(); // Restart spawner with new rate
            }, 30000); // Increase difficulty every 30 seconds
        }
    }

    setupEventListeners() {
        document.querySelectorAll('.unit-button').forEach(button => {
            button.addEventListener('click', () => this.spawnUnit(button.dataset.unit));
        });

        document.getElementById('retryButton').addEventListener('click', () => this.resetGame(true));
        document.getElementById('retryButtonLose').addEventListener('click', () => this.resetGame());
        document.getElementById('nextBattleButton').addEventListener('click', () => this.nextBattle());
        
        // Add new button event listeners
        document.getElementById('backToMenuButton').addEventListener('click', () => {
            this.resetGame(false); // Reset without keeping unlocks
            document.getElementById('mainMenu').style.display = 'flex';
            document.getElementById('gameContainer').style.display = 'none';
        });
        
        document.getElementById('backToMenuLoseButton').addEventListener('click', () => {
            this.resetGame(false); // Reset without keeping unlocks
            document.getElementById('mainMenu').style.display = 'flex';
            document.getElementById('gameContainer').style.display = 'none';
        });

        // Add event listeners for the secret menu
        document.getElementById('secretMenuTrigger').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('secretMenu').style.display = 'block';
        });

        document.querySelector('#secretMenu .close-button').addEventListener('click', () => {
            document.getElementById('secretMenu').style.display = 'none';
        });

        // Close secret menu when clicking outside
        window.addEventListener('click', (event) => {
            const secretMenu = document.getElementById('secretMenu');
            if (event.target === secretMenu) {
                secretMenu.style.display = 'none';
            }
        });
    }

    setupHelpSystem() {
        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'h') {
                const helpTooltip = document.getElementById('helpTooltip');
                helpTooltip.style.display = helpTooltip.style.display === 'none' ? 'block' : 'none';
            }
        });

        document.querySelector('#helpTooltip .close-button').addEventListener('click', () => {
            document.getElementById('helpTooltip').style.display = 'none';
        });
    }

    spawnUnit(type) {
        if (!this.unlockedUnits.includes(type)) return;
        
        const cost = this.unitStats[type].cost;
        if (this.gold >= cost) {
            this.gold -= cost;
            const unit = this.createUnit(type, true);
            this.units.push(unit);

            // Spawn green plumber companion when red plumber is created
            if (type === 'redPlumber') {
                const greenPlumber = this.createUnit('greenPlumber', true);
                // Position green plumber slightly behind red plumber
                greenPlumber.element.style.left = `${parseInt(unit.element.style.left) - 40}px`;
                this.units.push(greenPlumber);
            }

            this.updateUI();
        }
    }

    createUnit(type, isPlayer) {
        const stats = this.unitStats[type];
        const unit = document.createElement('div');
        unit.className = `unit ${isPlayer ? 'player-unit' : 'enemy-unit'} ${type}`;
        unit.style.left = isPlayer ? '170px' : '610px';
        unit.style.bottom = '125px';
        
        const healthBar = document.createElement('div');
        healthBar.className = 'health-bar';
        unit.appendChild(healthBar);

        document.getElementById('battlefield').appendChild(unit);

        const unitObj = {
            element: unit,
            health: stats.health,
            damage: stats.damage,
            speed: stats.speed,
            isPlayer,
            healthBar,
            type,
            lastAttack: 0
        };

        if (type === 'oldMan') {
            // Add glowing effect to show he's special
            unit.style.filter = 'drop-shadow(0 0 5px #FFD700)';
            
            // Create buff interval
            unitObj.buffInterval = setInterval(() => {
                if (unitObj.health > 0) {
                    // Find nearby friendly units
                    const oldManLeft = parseInt(unitObj.element.style.left);
                    this.units.forEach(otherUnit => {
                        if (otherUnit.isPlayer && otherUnit !== unitObj) {
                            const otherLeft = parseInt(otherUnit.element.style.left);
                            const distance = Math.abs(oldManLeft - otherLeft);
                            
                            if (distance < this.unitStats.oldMan.buffRadius) {
                                // Buff nearby unit's damage
                                if (!otherUnit.buffed) {
                                    otherUnit.originalDamage = otherUnit.damage;
                                    otherUnit.damage *= this.unitStats.oldMan.buffMultiplier;
                                    otherUnit.buffed = true;
                                    
                                    // Add visual effect to buffed unit
                                    otherUnit.element.style.filter = 'drop-shadow(0 0 3px gold)';
                                    
                                    // Create floating text effect
                                    const buffText = document.createElement('div');
                                    buffText.textContent = 'Power Up!';
                                    buffText.style.position = 'absolute';
                                    buffText.style.left = otherUnit.element.style.left;
                                    buffText.style.bottom = '180px';
                                    buffText.style.color = 'gold';
                                    buffText.style.textShadow = '0 0 5px #FFD700';
                                    buffText.style.animation = 'floatUp 1s forwards';
                                    document.getElementById('battlefield').appendChild(buffText);
                                    
                                    // Remove buff text after animation
                                    setTimeout(() => buffText.remove(), 1000);
                                }
                            } else if (otherUnit.buffed) {
                                // Remove buff when unit moves away
                                otherUnit.damage = otherUnit.originalDamage;
                                otherUnit.buffed = false;
                                otherUnit.element.style.filter = '';
                            }
                        }
                    });
                }
            }, this.unitStats.oldMan.buffInterval); // Close the interval properly
        }

        // Then continue with archer/wizard/alien check
        if (type === 'archer' || type === 'wizard' || type === 'alien') {
            unitObj.attackInterval = setInterval(() => {
                if (unitObj.health > 0) {
                    if (type === 'alien') {
                        this.shootLaser(unitObj);
                    } else {
                        this.shootArrow(unitObj);
                    }
                }
            }, type === 'alien' ? this.unitStats.alien.attackSpeed : 1000);
        }
        
        return unitObj;
    }

    shootArrow(unit) {
        const arrow = document.createElement('div');
        arrow.className = 'arrow';

        // Set initial position at the shooting unit's location
        const unitLeft = parseInt(unit.element.style.left);
        arrow.style.left = `${unitLeft}px`;
        arrow.style.bottom = '140px'; // Align with units

        document.getElementById('battlefield').appendChild(arrow);

        const arrowObj = {
            element: arrow,
            isPlayer: unit.isPlayer,
            damage: unit.damage * 0.5 // Arrows do half the unit's damage
        };

        this.arrows.push(arrowObj);
    }

    shootLaser(unit) {
        const laser = document.createElement('div');
        laser.className = 'laser';

        const unitLeft = parseInt(unit.element.style.left);
        laser.style.left = `${unitLeft}px`;
        laser.style.bottom = '140px';

        document.getElementById('battlefield').appendChild(laser);

        const laserObj = {
            element: laser,
            isPlayer: unit.isPlayer,
        };

        this.arrows.push(laserObj); // We'll use the same array for all projectiles
    }

    updateArrows() {
        for (let i = this.arrows.length - 1; i >= 0; i--) {
            const arrow = this.arrows[i];
            const currentLeft = parseInt(arrow.element.style.left);
            const newLeft = arrow.isPlayer ? 
                currentLeft + 10 : // Increase arrow speed
                currentLeft - 10;

            arrow.element.style.left = `${newLeft}px`;

            // Check for collisions with units
            for (let j = this.units.length - 1; j >= 0; j--) {
                const unit = this.units[j];
                if (unit.isPlayer !== arrow.isPlayer) {
                    const unitLeft = parseInt(unit.element.style.left);
                    const distance = Math.abs(newLeft - unitLeft);
                    if (distance < 40) {
                        unit.health -= arrow.damage;
                        const unitHealthPercent = (unit.health / this.unitStats[unit.type].health) * 100;
                        unit.healthBar.style.width = `${Math.max(0, unitHealthPercent)}%`;

                        if (unit.health <= 0) {
                            this.removeUnit(j);
                        }
                        this.removeArrow(i);
                        break;
                    }
                }
            }

            // Remove arrows that go off screen
            if (newLeft < 0 || newLeft > 800) {
                this.removeArrow(i);
            }
        }
    }

    updateUnits() {
        this.updateArrows();
        this.units.forEach((unit, index) => {
            const currentLeft = parseInt(unit.element.style.left);
            const stats = this.unitStats[unit.type];

            // Only move if not swinging (for hammer units)
            if (!(unit.type === 'hammer' && unit.isSwinging)) {
                const newLeft = unit.isPlayer ? 
                    currentLeft + unit.speed : 
                    currentLeft - unit.speed;

                unit.element.style.left = `${newLeft}px`;

                if (unit.isPlayer && newLeft > 610) { 
                    this.enemyBaseHealth -= unit.damage;
                    this.removeUnit(index);

                    // Add rock boss spawn when base is first hit and hasn't spawned yet
                    if (!this.rockBossSpawned) {
                        this.rockBossSpawned = true;
                        const rockBoss = this.createUnit('rockBoss', false);
                        this.units.push(rockBoss);
                    }
                } else if (!unit.isPlayer && newLeft < 170) { 
                    this.playerBaseHealth -= unit.damage;
                    this.removeUnit(index);
                }
            }

            // For collision detection, add updated check
            this.units.forEach((otherUnit, otherIndex) => {
                if (unit.isPlayer !== otherUnit.isPlayer) {
                    const distance = Math.abs(parseInt(unit.element.style.left) - 
                                               parseInt(otherUnit.element.style.left));
                    if (distance < 80) {
                        // Skip damage if hammer is swinging
                        if (unit.type === 'hammer' && unit.isSwinging) {
                            // Hammer does extra damage while swinging
                            otherUnit.health -= unit.damage * 1.5;
                            const otherHealthPercent = (otherUnit.health / this.unitStats[otherUnit.type].health) * 100;
                            otherUnit.healthBar.style.width = `${Math.max(0, otherHealthPercent)}%`;

                            if (otherUnit.health <= 0) {
                                // If killed by a zombie, turn into a zombie
                                if (unit.type === 'zombie') {
                                    let zombieType = 'zombie';
                                    let zombieClass = 'zombie';

                                    // Check unit type and assign appropriate zombie variant
                                    switch(otherUnit.type) {
                                        case 'fencer':
                                            zombieType = 'zombie-fencer';
                                            zombieClass = 'zombie-fencer';
                                            break;
                                        case 'knight':
                                            zombieType = 'zombie-knight';
                                            zombieClass = 'zombie-knight';
                                            break;
                                        case 'redPlumber':
                                            zombieType = 'zombie-red-plumber';
                                            zombieClass = 'zombie-red-plumber';
                                            break;
                                        case 'greenPlumber':
                                            zombieType = 'zombie-green-plumber';
                                            zombieClass = 'zombie-green-plumber';
                                            break;
                                        default:
                                            zombieType = 'zombie';
                                            zombieClass = 'zombie';
                                    }

                                    const zombieUnit = this.createUnit('zombie', unit.isPlayer);
                                    zombieUnit.element.style.left = otherUnit.element.style.left;
                                    zombieUnit.element.style.bottom = otherUnit.element.style.bottom;
                                    zombieUnit.element.classList.add(zombieClass);
                                    this.units.push(zombieUnit);
                                    
                                    // Create zombification effect
                                    const zombieText = document.createElement('div');
                                    zombieText.textContent = `ZOMBIFIED ${otherUnit.type.toUpperCase()}!`;
                                    zombieText.style.position = 'absolute';
                                    zombieText.style.left = otherUnit.element.style.left;
                                    zombieText.style.bottom = '180px';
                                    zombieText.style.color = '#50C878';
                                    zombieText.style.textShadow = '0 0 5px #50C878';
                                    zombieText.style.animation = 'floatUp 1s forwards';
                                    document.getElementById('battlefield').appendChild(zombieText);
                                }
                                this.removeUnit(index);
                            }
                            return; // Skip regular damage calculation
                        }

                        // Regular damage calculation
                        unit.health -= otherUnit.damage;
                        otherUnit.health -= unit.damage;

                        const unitStats = this.unitStats[unit.type];
                        const otherStats = this.unitStats[otherUnit.type];

                        if (unitStats && unit.healthBar) {
                            const unitHealthPercent = (unit.health / unitStats.health) * 100;
                            unit.healthBar.style.width = `${Math.max(0, unitHealthPercent)}%`;
                        }

                        if (otherStats && otherUnit.healthBar) {
                            const otherHealthPercent = (otherUnit.health / otherStats.health) * 100;
                            otherUnit.healthBar.style.width = `${Math.max(0, otherHealthPercent)}%`;
                        }

                        // Check if either unit dies
                        if (unit.health <= 0) {
                            // If killed by a zombie, turn into a zombie
                            if (otherUnit.type === 'zombie') {
                                let zombieType = 'zombie';
                                let zombieClass = 'zombie';

                                // Check unit type and assign appropriate zombie variant
                                switch(unit.type) {
                                    case 'fencer':
                                        zombieType = 'zombie-fencer';
                                        zombieClass = 'zombie-fencer';
                                        break;
                                    case 'knight':
                                        zombieType = 'zombie-knight';
                                        zombieClass = 'zombie-knight';
                                        break;
                                    case 'redPlumber':
                                        zombieType = 'zombie-red-plumber';
                                        zombieClass = 'zombie-red-plumber';
                                        break;
                                    case 'greenPlumber':
                                        zombieType = 'zombie-green-plumber';
                                        zombieClass = 'zombie-green-plumber';
                                        break;
                                    default:
                                        zombieType = 'zombie';
                                        zombieClass = 'zombie';
                                }

                                const zombieUnit = this.createUnit('zombie', otherUnit.isPlayer);
                                zombieUnit.element.style.left = unit.element.style.left;
                                zombieUnit.element.style.bottom = unit.element.style.bottom;
                                zombieUnit.element.classList.add(zombieClass);
                                this.units.push(zombieUnit);
                                
                                // Create zombification effect
                                const zombieText = document.createElement('div');
                                zombieText.textContent = `ZOMBIFIED ${unit.type.toUpperCase()}!`;
                                zombieText.style.position = 'absolute';
                                zombieText.style.left = unit.element.style.left;
                                zombieText.style.bottom = '180px';
                                zombieText.style.color = '#50C878';
                                zombieText.style.textShadow = '0 0 5px #50C878';
                                zombieText.style.animation = 'floatUp 1s forwards';
                                document.getElementById('battlefield').appendChild(zombieText);
                                
                                setTimeout(() => zombieText.remove(), 1000);
                            }
                            this.removeUnit(index);
                        }
                        if (otherUnit.health <= 0) {
                            // If killed by a zombie, turn into a zombie
                            if (unit.type === 'zombie') {
                                let zombieType = 'zombie';
                                let zombieClass = 'zombie';

                                // Check unit type and assign appropriate zombie variant
                                switch(otherUnit.type) {
                                    case 'fencer':
                                        zombieType = 'zombie-fencer';
                                        zombieClass = 'zombie-fencer';
                                        break;
                                    case 'knight':
                                        zombieType = 'zombie-knight';
                                        zombieClass = 'zombie-knight';
                                        break;
                                    case 'redPlumber':
                                        zombieType = 'zombie-red-plumber';
                                        zombieClass = 'zombie-red-plumber';
                                        break;
                                    case 'greenPlumber':
                                        zombieType = 'zombie-green-plumber';
                                        zombieClass = 'zombie-green-plumber';
                                        break;
                                    default:
                                        zombieType = 'zombie';
                                        zombieClass = 'zombie';
                                }

                                const zombieUnit = this.createUnit('zombie', unit.isPlayer);
                                zombieUnit.element.style.left = otherUnit.element.style.left;
                                zombieUnit.element.style.bottom = otherUnit.element.style.bottom;
                                zombieUnit.element.classList.add(zombieClass);
                                this.units.push(zombieUnit);
                                
                                // Create zombification effect
                                const zombieText = document.createElement('div');
                                zombieText.textContent = `ZOMBIFIED ${otherUnit.type.toUpperCase()}!`;
                                zombieText.style.position = 'absolute';
                                zombieText.style.left = otherUnit.element.style.left;
                                zombieText.style.bottom = '180px';
                                zombieText.style.color = '#50C878';
                                zombieText.style.textShadow = '0 0 5px #50C878';
                                zombieText.style.animation = 'floatUp 1s forwards';
                                document.getElementById('battlefield').appendChild(zombieText);
                                
                                setTimeout(() => zombieText.remove(), 1000);
                            }
                            this.removeUnit(otherIndex);
                        }
                    }
                }
            });

            // Add mushroom eating check for plumbers
            if ((unit.type === 'redPlumber' || unit.type === 'greenPlumber') && unit.isPlayer) {
                this.units.forEach((otherUnit, otherIndex) => {
                    if (otherUnit.type === 'mushroom') {
                        const distance = Math.abs(parseInt(unit.element.style.left) - 
                                                   parseInt(otherUnit.element.style.left));
                        if (distance < 40 && !unit.isSuper) {
                            // Power up the plumber
                            unit.isSuper = true;
                            unit.health *= 2;
                            unit.damage *= 2;
                            unit.element.classList.add('super', 'powering-up');
                            
                            // Create power up effect
                            const powerUpText = document.createElement('div');
                            powerUpText.textContent = 'POWER UP!';
                            powerUpText.style.position = 'absolute';
                            powerUpText.style.left = unit.element.style.left;
                            powerUpText.style.bottom = '180px';
                            powerUpText.style.color = '#FFD700';
                            powerUpText.style.textShadow = '0 0 5px #FFD700';
                            powerUpText.style.animation = 'floatUp 1s forwards';
                            document.getElementById('battlefield').appendChild(powerUpText);
                            
                            // Remove text after animation
                            setTimeout(() => powerUpText.remove(), 1000);
                            
                            // Remove the mushroom
                            this.removeUnit(otherIndex);
                            
                            // Play power up sound effect if we had one
                            
                            // Remove power up after 15 seconds
                            setTimeout(() => {
                                if (unit.health > 0) { // Only if unit still alive
                                    unit.isSuper = false;
                                    unit.health /= 2;
                                    unit.damage /= 2;
                                    unit.element.classList.remove('super');
                                }
                            }, 15000);
                        }
                    }
                });
            }
        });

        // Update base health bars
        document.querySelector('#playerBase .health-bar').style.width = `${this.playerBaseHealth}%`;
        document.querySelector('#enemyBase .health-bar').style.width = `${this.enemyBaseHealth}%`;

        this.checkGameEnd();
    }

    removeArrow(index) {
        if (this.arrows[index]) {
            this.arrows[index].element.remove();
            this.arrows.splice(index, 1);
        }
    }

    removeUnit(index) {
        if (this.units[index]) {
            if ((this.units[index].type === 'derpbot' || this.units[index].type === 'miniDerpbot') 
                && !this.units[index].isPlayer) {
                // If an enemy derpbot or mini derpbot is defeated and we haven't unlocked it yet
                if (!this.unlockedUnits.includes('derpbot') && !this.defeatedDerpbot) {
                    this.defeatedDerpbot = true;
                    this.unlockedUnits.push('derpbot');
                    this.unlockedUnits.push('miniDerpbot');
                    
                    // Create floating text effect
                    const unlockText = document.createElement('div');
                    unlockText.textContent = 'Derpbot Units Unlocked!';
                    unlockText.style.position = 'absolute';
                    unlockText.style.left = this.units[index].element.style.left;
                    unlockText.style.bottom = '180px';
                    unlockText.style.color = '#FFD700';
                    unlockText.style.textShadow = '0 0 5px #FFD700';
                    unlockText.style.animation = 'floatUp 2s forwards';
                    document.getElementById('battlefield').appendChild(unlockText);
                    
                    setTimeout(() => unlockText.remove(), 2000);
                    this.updateUI();
                }
            }
            if (this.units[index].attackInterval) {
                clearInterval(this.units[index].attackInterval);
            }
            if (this.units[index].spawnInterval) {
                clearInterval(this.units[index].spawnInterval);
            }
            if (this.units[index].buffInterval) {
                clearInterval(this.units[index].buffInterval);
            }
            if (this.units[index].swingInterval) {
                clearInterval(this.units[index].swingInterval);
            }
            this.units[index].element.remove();
            this.units.splice(index, 1);
        }
    }

    checkGameEnd() {
        if (this.playerBaseHealth <= 0) {
            clearInterval(this.enemySpawnInterval);
            document.getElementById('loseScreen').style.display = 'flex';
        } else if (this.enemyBaseHealth <= 0) {
            clearInterval(this.enemySpawnInterval);
            const newUnitUnlocked = this.unlockNewUnit();
            document.getElementById('winScreen').style.display = 'flex';
        }
    }

    unlockNewUnit() {
        this.bux += 10; // Award 10 bux for winning
        localStorage.setItem('bux', this.bux.toString()); // Add toString() to ensure proper string storage
        this.updateMainMenuBux(); // Add this line
        
        // Create floating bux notification
        const buxText = document.createElement('div');
        buxText.style.position = 'absolute';
        buxText.style.left = '50%';
        buxText.style.top = '50%';
        buxText.style.transform = 'translate(-50%, -50%)';
        buxText.style.color = '#FFD700';
        buxText.style.fontSize = '24px';
        buxText.style.textShadow = '0 0 5px #000';
        buxText.style.display = 'flex';
        buxText.style.alignItems = 'center';
        buxText.style.gap = '10px';
        buxText.innerHTML = `
            <img src="bux.png" style="width: 32px; height: 32px;">
            <span>+10 Bux!</span>
        `;
        buxText.style.animation = 'floatUp 2s forwards';
        document.getElementById('battlefield').appendChild(buxText);
        
        setTimeout(() => buxText.remove(), 2000);
        
        return false; // Don't show new unit unlock message
    }

    updateUI() {
        document.getElementById('goldAmount').textContent = this.gold;
        
        document.getElementById('resources').innerHTML = `
            Gold: <span id="goldAmount">${this.gold}</span>
            <span style="margin-left: 20px; display: flex; align-items: center; gap: 5px;">
                <img src="bux.png" style="width: 24px; height: 24px;"> 
                <span id="buxAmount">${this.bux}</span>
            </span>
        `;
        
        // Show only unlocked units
        document.querySelectorAll('.unit-button').forEach(button => {
            const unitType = button.dataset.unit;
            if (this.unlockedUnits.includes(unitType)) {
                button.classList.remove('locked');
                button.style.display = 'block';  // Make sure unlocked units are visible
            } else {
                button.classList.add('locked');
                button.style.display = 'none';  // Hide locked units
            }
        });
    }

    startEnemySpawner() {
        if (this.enemySpawnInterval) {
            clearInterval(this.enemySpawnInterval);
        }
        
        const settings = this.modeSettings[this.gameMode];

        this.enemySpawnInterval = setInterval(() => {
            const randomUnit = Math.random();
            let unitType;
            
            // Special handling for zombie mode
            if (this.gameMode === 'zombie') {
                unitType = 'zombie'; // Only spawn zombies in zombie mode
            }
            else if (this.gameMode === 'survival' && this.wave > 3) {
                if (randomUnit < 0.2) {
                    unitType = 'soldier';
                } else if (randomUnit < 0.4) {
                    unitType = 'knight';
                } else if (randomUnit < 0.6) {
                    unitType = 'evilWizard';
                } else if (randomUnit < 0.75) {
                    unitType = 'derpbot';
                } else if (randomUnit < 0.9) {
                    unitType = 'miniDerpbot';
                } else {
                    unitType = 'zombie';
                }
            } else {
                if (randomUnit < 0.35) {
                    unitType = 'soldier';
                } else if (randomUnit < 0.55) {
                    unitType = 'knight';
                } else if (randomUnit < 0.7) {
                    unitType = 'evilWizard';
                } else if (randomUnit < 0.8) {
                    unitType = 'derpbot';
                } else if (randomUnit < 0.9) {
                    unitType = 'miniDerpbot';
                } else {
                    unitType = 'zombie';
                }
            }
            
            const unit = this.createUnit(unitType, false);
            if (this.gameMode === 'zombie') {
                // Make zombies slightly stronger in zombie mode
                unit.health *= 1.2;
                unit.damage *= 1.2;
            }
            this.units.push(unit);
        }, settings.enemySpawnRate);
    }

    resetGame(keepUnlocks = false, resetBux = false) {
        // Clear any existing intervals
        if (this.enemySpawnInterval) {
            clearInterval(this.enemySpawnInterval);
        }
        
        this.gold = 150;
        if (resetBux) {
            this.bux = 0;
            localStorage.setItem('bux', 0);
        } else {
            // Load bux from localStorage
            this.bux = parseInt(localStorage.getItem('bux')) || 0;
        }
        this.playerBaseHealth = 100;
        this.enemyBaseHealth = 100 + (this.level - 1) * 10;
        
        // Clear existing units and arrows
        this.units.forEach(unit => {
            if (unit.attackInterval) {
                clearInterval(unit.attackInterval);
            }
            if (unit.spawnInterval) {
                clearInterval(unit.spawnInterval);
            }
            if (unit.buffInterval) {
                clearInterval(unit.buffInterval);
            }
            if (unit.swingInterval) {
                clearInterval(unit.swingInterval);
            }
            unit.element.remove();
        });
        this.units = [];
        
        this.arrows.forEach(arrow => arrow.element.remove());
        this.arrows = [];
        
        document.getElementById('winScreen').style.display = 'none';
        document.getElementById('loseScreen').style.display = 'none';
        
        if (!keepUnlocks) {
            this.unlockedUnits = ['soldier', 'fencer', 'redPlumber', 'mushroom', 'hammer'];
            this.level = 1;
            this.defeatedDerpbot = false; // Reset the flag only when not keeping unlocks
            const mainMenu = document.getElementById('mainMenu');
            const gameContainer = document.getElementById('gameContainer');
            mainMenu.style.display = 'flex';
            gameContainer.style.display = 'none';
        }
        
        this.rockBossSpawned = false; // Reset rock boss spawn flag
        this.startEnemySpawner();
        this.updateUI();
    }

    nextBattle() {
        this.level++;
        this.enemyBaseHealth = 100 + (this.level - 1) * 10; // Changed from 20 to 10
        this.resetGame(true);
    }

    purchaseUnit(unit) {
        const prices = {
            'archer': 10,
            'knight': 15,
            'wizard': 25,
            'alien': 30,
            'oldMan': 35,
            'goblin': 20,  // Add goblin price
            'zombie': 0    // Set price for zombie
        };

        const price = prices[unit];
        
        if (this.bux >= price && !this.unlockedUnits.includes(unit)) {
            this.bux -= price;
            localStorage.setItem('bux', this.bux.toString()); // Add toString() to ensure proper string storage
            this.updateMainMenuBux(); // Add this line
            
            // Add to unlocked units
            this.unlockedUnits.push(unit);
            
            // Show purchase confirmation
            this.showPurchaseConfirmation(unit);
            
            // Update UI
            this.updateUI();
        } else if (this.unlockedUnits.includes(unit)) {
            this.showPurchaseError('You already own this unit!');
        } else {
            this.showPurchaseError('Not enough Bux!');
        }
    }

    showPurchaseConfirmation(unit) {
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '50%';
        modal.style.left = '50%';
        modal.style.transform = 'translate(-50%, -50%)';
        modal.style.background = 'rgba(0, 0, 0, 0.9)';
        modal.style.padding = '30px';
        modal.style.borderRadius = '10px';
        modal.style.border = '2px solid #4a4a6b';
        modal.style.color = 'white';
        modal.style.textAlign = 'center';
        modal.style.zIndex = '1000';
        
        modal.innerHTML = `
            <h2 style="color: #FFD700">Unit Purchased!</h2>
            <p>You have unlocked: ${unit}</p>
            <button onclick="this.parentElement.remove()" style="margin-top: 20px; padding: 10px 20px; background: #4A5BB9; border: none; color: white; cursor: pointer; border-radius: 5px;">Close</button>
        `;
        
        document.body.appendChild(modal);
    }

    showPurchaseError(message) {
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '50%';
        modal.style.left = '50%';
        modal.style.transform = 'translate(-50%, -50%)';
        modal.style.background = 'rgba(0, 0, 0, 0.9)';
        modal.style.padding = '30px';
        modal.style.borderRadius = '10px';
        modal.style.border = '2px solid #4a4a6b';
        modal.style.color = 'white';
        modal.style.textAlign = 'center';
        modal.style.zIndex = '1000';
        
        modal.innerHTML = `
            <h2 style="color: #FF4444">Purchase Failed</h2>
            <p>${message}</p>
            <button onclick="this.parentElement.remove()" style="margin-top: 20px; padding: 10px 20px; background: #4A5BB9; border: none; color: white; cursor: pointer; border-radius: 5px;">Close</button>
        `;
        
        document.body.appendChild(modal);
    }
}

const game = new Game();
</script>
</body></html>
